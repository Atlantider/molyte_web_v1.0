# 文件上传策略说明

## 📋 概述

由于 MD 模拟会产生大量数据（特别是轨迹文件），我们采用**智能选择性上传**策略，只上传必要的结果文件到云端对象存储（COS/OSS），而将大文件保留在本地集群。

---

## 📂 文件分类

### 1️⃣ 必须上传的文件（Essential Files）

这些文件较小但包含关键信息，**总是上传**到云端：

| 文件类型 | 说明 | 典型大小 |
|---------|------|---------|
| `*.data` | LAMMPS 数据文件（初始结构） | < 1 MB |
| `*.log` | LAMMPS/Gaussian 日志文件 | < 10 MB |
| `*.xlsx` | 分析结果（RDF、MSD、电导率等） | < 5 MB |
| `*.png` | 图表（RDF 图、MSD 图等） | < 1 MB |
| `*.json` | JSON 格式的结果数据 | < 1 MB |
| `*.fchk` | Gaussian 格式化检查点文件 | < 50 MB |
| `final_frame_*.pdb` | **最后一帧结构**（从轨迹提取） | < 5 MB |

**总计**: 通常 < 100 MB

---

### 2️⃣ 可选上传的文件（Optional Large Files）

这些文件较大，**仅在用户明确请求时上传**：

| 文件类型 | 说明 | 典型大小 |
|---------|------|---------|
| `*.cube` | Gaussian Cube 文件（电子密度、ESP 等） | 50-500 MB |

---

### 3️⃣ 明确排除的文件（Excluded Files）

这些文件**永不上传**到云端，只保留在本地集群：

| 文件类型 | 说明 | 典型大小 | 本地保留时间 |
|---------|------|---------|-------------|
| `*.dump` | LAMMPS 轨迹文件 | 500 MB - 10 GB | 30 天 |
| `*.trj` | 轨迹文件 | 500 MB - 10 GB | 30 天 |
| `*.dcd` | 二进制轨迹 | 500 MB - 10 GB | 30 天 |
| `*.xtc` | 压缩轨迹 | 100 MB - 5 GB | 30 天 |

**原因**：
- 文件太大，上传耗时且占用存储空间
- 大多数分析只需要最后一帧（平衡态结构）
- 用户如需完整轨迹，可以直接从集群下载

---

## 🔄 轨迹文件处理流程

### 问题
LAMMPS 轨迹文件（`.dump`）通常包含数千到数万帧，文件大小可达 GB 级别。

### 解决方案
**只提取并上传最后一帧**

```
┌─────────────────────────────────────────────────────────────┐
│  LAMMPS 轨迹文件 (trajectory.dump)                          │
│  ┌────┬────┬────┬─────┬─────────────────────┬────┐         │
│  │帧1 │帧2 │帧3 │ ... │ 帧9998 │ 帧9999 │帧10000│         │
│  └────┴────┴────┴─────┴─────────────────────┴────┘         │
│                                              ↓               │
│                                         提取最后一帧          │
│                                              ↓               │
│                                    final_frame_123.pdb       │
│                                         (< 5 MB)             │
└─────────────────────────────────────────────────────────────┘
                                              ↓
                                         上传到云端
```

### 实现细节

1. **自动提取**：Worker 在任务完成后自动提取最后一帧
2. **格式转换**：转换为 PDB 格式（通用、易于可视化）
3. **文件命名**：`final_frame_{job_id}.pdb`
4. **包含信息**：
   - 所有原子的坐标
   - 原子类型
   - 任务 ID（备注中）

### 代码示例

<augment_code_snippet path="deployment/polling_worker.py" mode="EXCERPT">
````python
def _extract_last_frame(self, work_dir: Path, job_id: int) -> Optional[Path]:
    """从 LAMMPS 轨迹文件中提取最后一帧"""
    dump_files = list(work_dir.glob("*.dump"))
    # ... 读取最后一帧
    # ... 转换为 PDB 格式
    output_file = work_dir / f"final_frame_{job_id}.pdb"
    # ... 保存
    return output_file
````
</augment_code_snippet>

---

## 📊 存储空间对比

### 传统方案（上传所有文件）

| 任务数 | 每任务大小 | 总存储 | 月成本（COS） |
|-------|-----------|--------|--------------|
| 100   | 2 GB      | 200 GB | ~40 元 |
| 1000  | 2 GB      | 2 TB   | ~400 元 |

### 优化方案（只上传必要文件）

| 任务数 | 每任务大小 | 总存储 | 月成本（COS） |
|-------|-----------|--------|--------------|
| 100   | 50 MB     | 5 GB   | ~1 元 |
| 1000  | 50 MB     | 50 GB  | ~10 元 |

**节省**: 95% 存储空间，95% 成本 💰

---

## 🔧 配置说明

### 配置文件位置
`deployment/polling_worker_config_tencent.yaml`

### 关键配置项

```yaml
upload:
  # 必须上传的文件
  essential_files:
    - "*.data"
    - "*.log"
    - "*.xlsx"
    - "*.png"
    - "*.json"
    - "*.fchk"
  
  # 明确排除的文件（不上传）
  excluded_files:
    - "*.dump"          # LAMMPS 轨迹
    - "*.trj"
    - "*.dcd"
    - "*.xtc"
  
  # 轨迹文件处理
  trajectory_handling:
    enabled: true
    upload_full_trajectory: false      # 不上传完整轨迹
    extract_last_frame: true           # 提取最后一帧
    last_frame_format: "pdb"           # PDB 格式
    keep_local_trajectory: true        # 保留本地轨迹
    local_retention_days: 30           # 本地保留 30 天
```

---

## 🚀 使用场景

### 场景 1: 用户提交 MD 任务

1. ✅ 用户在 Web 界面提交任务
2. ✅ 校园网 Worker 执行 LAMMPS 模拟
3. ✅ 生成轨迹文件 `trajectory.dump` (2 GB)
4. ✅ Worker 提取最后一帧 → `final_frame_123.pdb` (3 MB)
5. ✅ 上传必要文件到 COS：
   - `system.data` (500 KB)
   - `lammps.log` (5 MB)
   - `rdf_results.xlsx` (2 MB)
   - `rdf_plot.png` (500 KB)
   - `final_frame_123.pdb` (3 MB)
   - **总计**: ~11 MB
6. ✅ 轨迹文件保留在本地 30 天

### 场景 2: 用户查看结果

1. ✅ 用户在 Web 界面查看任务详情
2. ✅ 下载分析结果（Excel、图表）
3. ✅ 在线查看最后一帧结构（PDB 可视化）
4. ✅ 如需完整轨迹，联系管理员从集群下载

### 场景 3: 用户需要完整轨迹

**方式 1: 直接从集群下载**（推荐）
```bash
# 用户通过 SSH 连接到集群
ssh user@cluster.university.edu

# 找到任务目录
cd /public/home/xiaoji/molyte_web/data/md_work/MD-20251130-0001-xxx

# 下载轨迹文件
scp trajectory.dump user@local-machine:/path/to/save/
```

**方式 2: 按需上传**（未来功能）
- 用户在 Web 界面点击"请求完整轨迹"
- Worker 收到请求后上传完整轨迹到 COS
- 用户收到通知后下载

---

## 📈 监控和维护

### 本地存储清理

轨迹文件在本地保留 30 天后自动清理：

```bash
# 添加到 crontab
0 2 * * * find /public/home/xiaoji/molyte_web/data/md_work -name "*.dump" -mtime +30 -delete
```

### 存储使用统计

```bash
# 查看各类型文件占用空间
cd /public/home/xiaoji/molyte_web/data/md_work
du -sh */*.dump    # 轨迹文件
du -sh */*.data    # 数据文件
du -sh */*.log     # 日志文件
```

### COS 存储监控

在腾讯云控制台查看：
- 存储容量趋势
- 流量使用情况
- 成本分析

---

## ❓ 常见问题

### Q1: 为什么不上传轨迹文件？
**A**: 轨迹文件太大（GB 级别），上传耗时且占用大量存储空间。大多数分析只需要最后一帧（平衡态结构）。

### Q2: 如果我需要完整轨迹怎么办？
**A**: 轨迹文件在本地集群保留 30 天，您可以：
1. 通过 SSH 直接从集群下载
2. 联系管理员协助获取
3. （未来）在 Web 界面请求按需上传

### Q3: 最后一帧够用吗？
**A**: 对于大多数分析（RDF、配位数、溶剂化结构等），最后一帧（平衡态）已经足够。如需动力学分析（MSD、扩散系数），这些结果已经在 Excel 文件中。

### Q4: 本地存储空间不够怎么办？
**A**: 
1. 减少 `local_retention_days`（如改为 7 天）
2. 定期手动清理旧任务
3. 增加集群存储容量

### Q5: 能否压缩轨迹文件后上传？
**A**: 即使压缩，轨迹文件仍然很大（通常压缩后仍有数百 MB）。考虑到上传时间和存储成本，不推荐。

---

## 🎯 总结

| 方面 | 传统方案 | 优化方案 |
|-----|---------|---------|
| **上传时间** | 10-30 分钟/任务 | < 1 分钟/任务 |
| **存储成本** | 高（~400元/月） | 低（~10元/月） |
| **网络带宽** | 高占用 | 低占用 |
| **用户体验** | 等待时间长 | 快速查看结果 |
| **数据完整性** | 完整 | 关键数据完整 |

**结论**: 优化方案在保证用户能获取所有必要结果的前提下，大幅降低了成本和上传时间。✅

